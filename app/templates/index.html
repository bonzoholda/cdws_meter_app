<!-- app/templates/index.html -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CDWS Meter Entry</title>
  <link rel="stylesheet" href="static/style.css" />
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h2>Meter Record Form</h2>

  <form id="uploadForm" enctype="multipart/form-data" method="post">
    <label>User ID:</label>
    <input type="text" name="user_id" id="user_id" required /><br />

    <label>SR No:</label>
    <input type="text" name="sr_no" id="sr_no" required /><br />

    <label>Meter Photo:</label>
    <input type="file" name="image" accept="image/*" capture="environment" required /><br />

    <button type="submit">Submit</button>
  </form>

  <div>
    <h3>Scan QR</h3>
    <select id="targetField">
      <option value="user_id">User ID</option>
      <option value="sr_no">SR No</option>
    </select>
    <div id="qr-reader" style="width: 300px; margin-top: 10px;"></div>

    <button id="startScanner" style="margin-top: 10px;">Start Scanner</button>
    <button id="stopScanner" style="margin-top: 10px;" disabled>Stop Scanner</button>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      try {
        const response = await fetch("/upload-image/", {
          method: "POST",
          body: formData,
        });
        const result = await response.json();
        alert(result.message || "Upload completed.");
        form.reset();
      } catch (error) {
        alert("Upload failed: " + error.message);
      }
    });

    const qrReader = new Html5Qrcode("qr-reader");
    const startBtn = document.getElementById("startScanner");
    const stopBtn = document.getElementById("stopScanner");

    async function hasCamera() {
      try {
        const devices = await Html5Qrcode.getCameras();
        return devices && devices.length > 0;
      } catch (err) {
        console.error("Camera check failed:", err);
        return false;
      }
    }

    startBtn.addEventListener("click", async () => {
      const cameraAvailable = await hasCamera();
      if (!cameraAvailable) {
        alert("No camera found on this device.");
        return;
      }

      startBtn.disabled = true;
      stopBtn.disabled = false;

      qrReader
        .start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (qrCodeMessage) => {
            const target = document.getElementById("targetField").value;
            document.getElementById(target).value = qrCodeMessage;
          },
          (errorMessage) => {
            // ignore scan errors or log them
            // console.log("QR scan error:", errorMessage);
          }
        )
        .catch((err) => {
          console.error("Unable to start QR scanner:", err);
          alert("Failed to start QR scanner: " + err.message);
          startBtn.disabled = false;
          stopBtn.disabled = true;
        });
    });

    stopBtn.addEventListener("click", () => {
      qrReader.stop()
        .then(() => {
          startBtn.disabled = false;
          stopBtn.disabled = true;
          // Clear QR reader UI
          document.getElementById("qr-reader").innerHTML = "";
        })
        .catch((err) => {
          console.error("Failed to stop QR scanner:", err);
        });
    });
  </script>
</body>
</html>
